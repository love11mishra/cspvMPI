#!/bin/bash

set -e
DIR=`dirname $0`/..
CILLY=${DIR}/cil/bin/cilly
MPI_FLAGS=`mpicc -compile_info`
echo $CILLY
#CILLY=cilly

TARGET=`expr $1 : '\(.*\)\.c'`

rm -f idcount stmtcount funcount cfg_func_map cfg branches cfg_branches

#${CILLY} $1 -o ${TARGET} --save-temps --doCrestInstrument \
#    -I${DIR}/include -L${DIR}/lib -lcrest -lstdc++ -g

${CILLY} $1 -c --save-temps --doCrestInstrument \
    -I${DIR}/include -L${DIR}/lib ${MPI_FLAGS}	

mpicc -c ${TARGET}.cil.c -o ${TARGET}.cil.o
mpic++ -L${DIR}/lib/ ${TARGET}.cil.o -lcrest -lstdc++ -o ${TARGET}
${DIR}/bin/process_cfg
